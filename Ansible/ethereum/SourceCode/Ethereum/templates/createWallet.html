{% extends 'template.html' %}

{% block pageTitle %}.:: Wallet : Create Wallet ::.{% endblock %}

{% block pageHeader %}.:: Wallet : Create Wallet ::.{% endblock %}

{% block cssLink %}

{% endblock %}



{% block jsLink %}


<script type = "text/javascript" src ="{{ url_for('static', filename = 'js/web3/web3.min.js') }}" ></script>

<script src="{{ url_for('static', filename = 'js/web3/keythereum.min.js') }}"  type="text/javascript"></script>

<script type = "text/javascript" src ="{{ url_for('static', filename = 'js/jquery-3.3.1.min.js') }}" ></script>

<script type = "text/javascript" src ="{{ url_for('static', filename = 'js/particles.js') }}" ></script>

<script src="{{ url_for('static', filename = 'js/sweetalert.min.js') }}"></script>

{% endblock %}

{% block content %}
<h3  class="breakh3" style="">Create Wallet</h3>
<table class="tblProcess">
	<tr><td>Type your Password:</td></tr>
	<tr>
		<td>
			<input class="txt" type="text" name="toAddress" id="txtcreatepassword" value="" />
		</td>
	</tr>
	
	<tr>
		<td>
			<input class="btn" type="button" name="btnSubmit" id="btncreateWallet" value="Create Wallet" />
		</td>
	</tr>
	
</table><br>
<br><br><h3  class="breakh3" style="">Import Wallet from File</h3>
<br>
<table class="tblProcess">
		<tr><td>Choose file:</td></tr>
		<tr>
			<td>
				<input class="txt" type="file" name="toAddress" id="txtToAddress" value="" />
			</td>
		</tr>
		
		<tr>
			<td>
				<input class="btn" type="button" name="btnSubmit" id="btnSubmit" value="Import Wallet" />
			</td>
		</tr>
		
	</table>
	<br><br><br> <h3  class="breakh3" style="">Import wallet with private key.</h3><br>
	<table class="tblProcess">
		<tr><td>Type your private Key:</td></tr>
		<tr>
			<td>
				<input class="txt" type="text" name="toAddress" id="txtPrivateKeyDecrypt" value="" />
			</td>
		</tr>
		
		<tr>
			<td>
				<input class="btn" type="button" name="btnSubmit" id="btnPrivateKeyDecrypt" value="Decrypt Wallet" />
			</td>
		</tr>
		
	</table>
{% endblock %}

{% block js %}
<script>
$("#btnLogin").click(function(event){
    $("#frmLogin").submit();

$('form').fadeOut(500);
$('.wrapper').addClass('form-success');
});
</script>


<script>
	setTimeout(function () {
	  particlesJS('particles-js',
	{
	  "particles": {
		"number": {
		  "value": 80,
		  "density": {
			"enable": true,
			"value_area": 800
		  }
		},
		"color": {
		  "value": "#ffffff"
		},
		"shape": {
		  "type": "circle",
		  "stroke": {
			"width": 0,
			"color": "#000000"
		  },
		  "polygon": {
			"nb_sides": 5
		  },
		  "image": {
			"src": "img/github.svg",
			"width": 100,
			"height": 100
		  }
		},
		"opacity": {
		  "value": 0.5,
		  "random": false,
		  "anim": {
			"enable": false,
			"speed": 1,
			"opacity_min": 0.1,
			"sync": false
		  }
		},
		"size": {
		  "value": 5,
		  "random": true,
		  "anim": {
			"enable": false,
			"speed": 40,
			"size_min": 0.1,
			"sync": false
		  }
		},
		"line_linked": {
		  "enable": true,
		  "distance": 150,
		  "color": "#ffffff",
		  "opacity": 0.4,
		  "width": 1
		},
		"move": {
		  "enable": true,
		  "speed": 6,
		  "direction": "none",
		  "random": false,
		  "straight": false,
		  "out_mode": "out",
		  "attract": {
			"enable": false,
			"rotateX": 600,
			"rotateY": 1200
		  }
		}
	  },
	  "interactivity": {
		"detect_on": "canvas",
		"events": {
		  "onhover": {
			"enable": true,
			"mode": "repulse"
		  },
		  "onclick": {
			"enable": true,
			"mode": "push"
		  },
		  "resize": true
		},
		"modes": {
		  "grab": {
			"distance": 400,
			"line_linked": {
			  "opacity": 1
			}
		  },
		  "bubble": {
			"distance": 400,
			"size": 40,
			"duration": 2,
			"opacity": 8,
			"speed": 3
		  },
		  "repulse": {
			"distance": 200
		  },
		  "push": {
			"particles_nb": 4
		  },
		  "remove": {
			"particles_nb": 2
		  }
		}
	  },
	  "retina_detect": true,
	  "config_demo": {
		"hide_card": false,
		"background_color": "#b61924",
		"background_image": "",
		"background_position": "50% 50%",
		"background_repeat": "no-repeat",
		"background_size": "cover"
	  }
	}
  
  );
	var count_particles, stats, update;
	  }, 0);
	
  $(document).ready(function(){
	  $("#particles-js").hide();
  });
  </script>
	  
  
  <script>
		function checkCookie() {
        var cpk = getCookie("cpk");
        var cadr = getCookie("cadr");
        if ( cadr != "" && cpk !="" ) {
            return true;
        } else {
            return false;
        }
    }

    if(checkCookie()){
      document.location="./myWallet";
    }
	  if (typeof web3 !== 'undefined') {
		  web3 = new Web3(web3.currentProvider);
	  } else {
		  web3 = new Web3(new Web3.providers.HttpProvider("https://rinkeby.infura.io/"));
	  }
	  var p_Key = "";
  
		function getPublicKey(pk,pa){
			/*web3.eth.sendTransaction(
          {
              
          },
          function(error,result){ //callback 
              
          }
      );*/
			key = web3.eth.accounts.encrypt(pk,pa,function(error,result){
				console.log('okokok all right');
			});
			return key;
		}
	  $("#btnPrivateKeyDecrypt").click(function(){
  
		  $("#particles-js").show("slow",function(){
			  var pK = $("#txtPrivateKeyDecrypt").val();
				pK = pK.replace("0x","");
			  p_Key = "";//keythereum.privateKeyToAddress(pK);
				try {
						p_Key = keythereum.privateKeyToAddress(pK);
				}
				catch(err) {
						alert("Invalid format!");
						$("#particles-js").hide();
						return;
				}
				//console.log(getPublicKey("0x"+pK,'aknakn0091'));
				/*if(!web3.isAddress("0x"+pK)){
					alert("Invalid format!");
					$("#particles-js").hide();
					return;
				}
				*/
			  cname = "cpk";
			  cvalue = pK;
			  exdays ="1";
			  setCookie(cname, cvalue, exdays);
			  cname = "cadr";
			  cvalue = p_Key;
			  exdays ="1";
			  setCookie(cname, cvalue, exdays);
			  $("#particles-js").hide();
			  document.location = "./myWallet";
		  });
	  });
	  $("#btncreateWallet").click(function(){
  
		  $("#particles-js").show("slow",function(){
			  var pass = $('#txtcreatepassword').val();
			  if(pass){
				  var params = { keyBytes: 32, ivBytes: 16 };
				  var dk = keythereum.create(params);
				  var keyDump = keythereum.dump(pass, dk.privateKey, dk.salt, dk.iv);
				  var address = keythereum.privateKeyToAddress(dk.privateKey.toString('hex')) //keyDump.address;
				  console.log(dk.privateKey.toString('hex')); // this is private key
				  keyfile = keythereum.exportToFile(keyDump);
				  $("#particles-js").hide();
				  tmpHtml = "<b>Address :</b> " + keyDump.address +
				  "<br> <b>Your private key :</b> " + dk.privateKey.toString('hex')+
				  "<br> Do you want to download your <b>key file</b>as csv?";
  
  
				  cname = "cpk";
				  cvalue = dk.privateKey.toString('hex');
				  exdays ="1";
				  setCookie(cname, cvalue, exdays);
				  cname = "cadr";
				  cvalue = keyDump.address;
				  exdays ="1";
				  setCookie(cname, cvalue, exdays);
				  
				  swal({
					  title: 'Success!',
					  html:tmpHtml,
					  type: 'success',
					  showCancelButton: true,
					  cancelButtonColor: '#110b219e',
					  confirmButtonText: 'Yes, Download it!'
					  }).then((result) => {
						  
					  if (result.value) {
						  exportToCsvFile(keyfile);
						  swal(
						  'Downloaded!',
						  "pls don't share it to other.",
						  'success'
						  ).then((s) => {
							  document.location = "./myWallet";
						  });
					  }
					  else{
						  document.location = "./myWallet";
					  }
				  });
  
				  
				  
			  }
			  else{
				  alert("Please Type Password First :-/ ");
				  $("#particles-js").hide();
			  }
		  });
		  
		  
		  
	  });
	  
	  function parseJSONToCSVStr(jsonData) {
		  if(jsonData.length == 0) {
			  return '';
		  }
		  
		  let keys = Object.keys(jsonData[0]);
		  
		  let columnDelimiter = ',';
		  let lineDelimiter = '\n';
		  
		  let csvColumnHeader = keys.join(columnDelimiter);
		  let csvStr = csvColumnHeader + lineDelimiter;
		  
		  jsonData.forEach(item => {
			  keys.forEach((key, index) => {
				  if( (index > 0) && (index < keys.length-1) ) {
					  csvStr += columnDelimiter;
				  }
				  csvStr += item[key];
			  });
			  csvStr += lineDelimiter;
		  });
  
		  return encodeURIComponent(csvStr);;
	  }
  
	  function exportToCsvFile(keyfile) {
		  let dataUri = 'data:text/csv;charset=utf-8,'+ keyfile;
		  
		  let exportFileDefaultName = 'data.csv';
		  
		  let linkElement = document.createElement('a');
		  linkElement.setAttribute('href', dataUri);
		  linkElement.setAttribute('download', exportFileDefaultName);
		  linkElement.click();
	  }
  
		  function setCookie(cname, cvalue, exdays) {
			  document.cookie = cname + "=" + cvalue + ";";
		  }
		  function getCookie(cname) {
			  var name = cname + "=";
			  var decodedCookie = decodeURIComponent(document.cookie);
			  var ca = decodedCookie.split(';');
			  for(var i = 0; i <ca.length; i++) {
				  var c = ca[i];
				  while (c.charAt(0) == ' ') {
					  c = c.substring(1);
				  }
				  if (c.indexOf(name) == 0) {
					  return c.substring(name.length, c.length);
				  }
			  }
			  return "";
		  }
		  
		  //checkCookie();
	  
		 
  </script>
{% endblock %}